---
phase: 03-json-error-handling
plan: 01
type: execute
---

<objective>
Verify JSON parsing error handling in title-extractor and add test coverage.

Purpose: The concern analysis flagged JSON.parse as unhandled, but code review shows it IS inside a try-catch. We should verify this is working correctly and add tests to protect against regressions.
Output: Test coverage for JSON parse error fallback behavior.
</objective>

<context>
@.planning/codebase/CONCERNS.md (concern #3)
@src/lib/title-extractor.ts

**Analysis:**
The concern states `JSON.parse` on line 67 has "no try-catch", but examining the code shows it IS wrapped in a try-catch (lines 41-81). The catch block properly falls back to low-confidence path. This concern appears to be a **false positive**.

However, there are no tests verifying this behavior. We should add test coverage.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add test for invalid JSON response handling</name>
  <files>src/lib/title-extractor.test.ts</files>
  <action>
Add test case to existing test file that verifies:
1. When Claude returns invalid JSON, the function returns low confidence fallback
2. Mock the Anthropic client to return non-JSON text
3. Verify no error is thrown and fallback result is returned

Test pattern:
```typescript
describe("JSON parsing error handling", () => {
  it("should fallback gracefully when Claude returns invalid JSON", async () => {
    // Mock client to return invalid JSON
    vi.mocked(client.messages.create).mockResolvedValueOnce({
      content: [{ type: "text", text: "This is not valid JSON" }],
      // ... other required fields
    } as any);

    const result = await extractFilmTitle("Some Movie Title");

    expect(result.confidence).toBe("low");
    expect(result.filmTitle).toBeDefined();
  });
});
```
  </action>
  <verify>`npm run test:run -- src/lib/title-extractor.test.ts` passes</verify>
  <done>Test verifies JSON error fallback behavior</done>
</task>

<task type="auto">
  <name>Task 2: Update CONCERNS.md</name>
  <files>.planning/codebase/CONCERNS.md</files>
  <action>
Update concern #3 to reflect that:
1. The code IS correctly wrapped in try-catch
2. Test coverage has been added
3. Mark as RESOLVED
  </action>
  <verify>File updated</verify>
  <done>Concern marked as resolved with explanation</done>
</task>

</tasks>

<verification>
- [ ] Test for JSON parse error handling passes
- [ ] CONCERNS.md updated with resolution
</verification>

<success_criteria>
- Test proves JSON.parse errors are caught and handled
- Documentation reflects actual code state
</success_criteria>

<output>
After completion, create `.planning/phases/03-json-error-handling/03-01-SUMMARY.md`
Then update STATE.md and ROADMAP.md
</output>
