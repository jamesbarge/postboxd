---
phase: 01-api-validation
plan: 01
type: execute
---

<objective>
Add Zod validation to admin screenings API route to prevent crashes from malformed requests.

Purpose: The PUT and PATCH endpoints accept raw JSON without schema validation, risking runtime errors from invalid data.
Output: Validated admin screenings route with tests proving validation works.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Pattern to follow:**
@src/app/api/screenings/route.ts (lines 16-47 show Zod validation pattern)

**Target file:**
@src/app/api/admin/screenings/[id]/route.ts

**Error handling:**
@src/lib/api-errors.ts

**Testing patterns:**
@.planning/codebase/TESTING.md

**Constraining decisions:**
- Tests required for each fix
- Follow existing codebase patterns
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Zod schemas for screening update</name>
  <files>src/app/api/admin/screenings/[id]/route.ts</files>
  <action>
Add Zod schemas at top of file after imports:
1. `updateScreeningSchema` for PUT - validates filmId (uuid optional), cinemaId (uuid optional), datetime (ISO string optional), bookingUrl (url optional), format (string nullable), screen (string nullable), eventType (string nullable), eventDescription (string nullable)
2. `patchScreeningSchema` for PATCH - validates datetime (ISO string optional), format (string nullable), screen (string nullable), eventType (string nullable)

Import `z` from "zod" and `BadRequestError, handleApiError` from "@/lib/api-errors".

Remove the `UpdateScreeningBody` interface - replace with inferred type from schema.
  </action>
  <verify>TypeScript compiles without errors: `npx tsc --noEmit`</verify>
  <done>Zod schemas defined, old interface removed, imports updated</done>
</task>

<task type="auto">
  <name>Task 2: Update PUT and PATCH handlers to use Zod validation</name>
  <files>src/app/api/admin/screenings/[id]/route.ts</files>
  <action>
In PUT handler:
1. Replace `const body: UpdateScreeningBody = await request.json()` with Zod safeParse pattern
2. Use `const parseResult = updateScreeningSchema.safeParse(await request.json())`
3. If `!parseResult.success`, throw `new BadRequestError("Invalid request body", parseResult.error.flatten())`
4. Use `parseResult.data` for validated fields
5. Wrap entire handler in try-catch and return `handleApiError(error)` on catch

In PATCH handler:
1. Same pattern with `patchScreeningSchema`
2. Replace `const body = await request.json()` with validated parse
3. Use `parseResult.data` instead of raw `body`

Keep existing business logic (existence checks, date parsing, DB updates) - only change is how body is parsed/validated.
  </action>
  <verify>Manual test: `curl -X PUT http://localhost:3000/api/admin/screenings/invalid-id -H "Content-Type: application/json" -d '{"filmId": "not-a-uuid"}' | jq` returns 400 with validation error</verify>
  <done>PUT returns 400 for invalid UUID format, PATCH returns 400 for invalid datetime format</done>
</task>

<task type="auto">
  <name>Task 3: Add tests for validation</name>
  <files>src/app/api/admin/screenings/[id]/route.test.ts</files>
  <action>
Create new test file with:
1. Mock Clerk auth to return userId
2. Mock db queries to return expected results
3. Test cases:
   - PUT with valid body returns success
   - PUT with invalid UUID format returns 400
   - PUT with invalid datetime returns 400
   - PUT without auth returns 401
   - PATCH with valid body returns success
   - PATCH with invalid datetime returns 400
   - DELETE returns success (no body validation needed)

Follow patterns from @.planning/codebase/TESTING.md:
- Use `vi.mock()` for dependencies
- Use `describe/it` structure
- Test error messages match expected format
  </action>
  <verify>`npm run test:run -- src/app/api/admin/screenings` passes all tests</verify>
  <done>Tests pass, cover validation error cases for PUT and PATCH</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx tsc --noEmit` succeeds
- [ ] `npm run test:run -- src/app/api/admin/screenings` passes
- [ ] `npm run lint` passes
- [ ] Invalid request bodies return 400 with structured error
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- PUT/PATCH endpoints reject malformed requests with 400
- Tests verify validation behavior
</success_criteria>

<output>
After completion, create `.planning/phases/01-api-validation/01-01-SUMMARY.md`
</output>
