---
phase: 01-api-validation
plan: 02
type: execute
---

<objective>
Add Zod validation to admin cinema config API route to prevent crashes from malformed requests.

Purpose: The PUT endpoint has manual validation that's incomplete - proper Zod schema provides consistent error handling.
Output: Validated admin cinema config route with tests proving validation works.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Pattern to follow:**
@src/app/api/screenings/route.ts (lines 16-47 show Zod validation pattern)

**Prior plan summary (if exists):**
@.planning/phases/01-api-validation/01-01-SUMMARY.md

**Target file:**
@src/app/api/admin/cinemas/[id]/config/route.ts

**Error handling:**
@src/lib/api-errors.ts

**Testing patterns:**
@.planning/codebase/TESTING.md

**Constraining decisions:**
- Tests required for each fix
- Follow existing codebase patterns
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Zod schema for cinema config update</name>
  <files>src/app/api/admin/cinemas/[id]/config/route.ts</files>
  <action>
Add Zod schema at top of file after imports:
`cinemaConfigSchema` for PUT - validates:
- tier: z.enum(["top", "standard"]).optional()
- tolerancePercent: z.number().min(10).max(100).optional()
- weekdayAvg: z.number().nullable().optional()
- weekendAvg: z.number().nullable().optional()
- manualOverride: z.boolean().optional()
- notes: z.string().nullable().optional()
- scrapeHorizonDays: z.number().min(7).max(365).optional()
- maxScrapeDate: z.string().datetime().nullable().optional()

Import `z` from "zod" and `BadRequestError, handleApiError` from "@/lib/api-errors".

Note: The existing manual validation checks can be removed as Zod handles them.
  </action>
  <verify>TypeScript compiles without errors: `npx tsc --noEmit`</verify>
  <done>Zod schema defined, imports updated</done>
</task>

<task type="auto">
  <name>Task 2: Update PUT handler to use Zod validation</name>
  <files>src/app/api/admin/cinemas/[id]/config/route.ts</files>
  <action>
In PUT handler:
1. Replace `const body = await request.json()` + manual destructuring with Zod safeParse pattern
2. Use `const parseResult = cinemaConfigSchema.safeParse(await request.json())`
3. If `!parseResult.success`, throw `new BadRequestError("Invalid request body", parseResult.error.flatten())`
4. Use `parseResult.data` for validated fields
5. Remove manual validation blocks (tier check, tolerancePercent parseInt, scrapeHorizonDays parseInt, maxScrapeDate date parse) - Zod handles all of this
6. Wrap entire handler in try-catch and return `handleApiError(error)` on catch

Keep existing business logic (cinema existence check, upsert logic).
  </action>
  <verify>Manual test: `curl -X PUT http://localhost:3000/api/admin/cinemas/test/config -H "Content-Type: application/json" -d '{"tier": "invalid"}' | jq` returns 400 with validation error</verify>
  <done>PUT returns 400 for invalid tier, invalid tolerancePercent range, invalid scrapeHorizonDays range</done>
</task>

<task type="auto">
  <name>Task 3: Add tests for validation</name>
  <files>src/app/api/admin/cinemas/[id]/config/route.test.ts</files>
  <action>
Create new test file with:
1. Mock Clerk auth to return userId
2. Mock db queries to return expected results
3. Test cases:
   - GET returns default config for non-existent baseline
   - GET returns 401 without auth
   - PUT with valid body returns success
   - PUT with invalid tier returns 400
   - PUT with tolerancePercent < 10 returns 400
   - PUT with tolerancePercent > 100 returns 400
   - PUT with scrapeHorizonDays < 7 returns 400
   - PUT with scrapeHorizonDays > 365 returns 400
   - PUT with invalid datetime for maxScrapeDate returns 400
   - PUT without auth returns 401

Follow patterns from @.planning/codebase/TESTING.md
  </action>
  <verify>`npm run test:run -- src/app/api/admin/cinemas` passes all tests</verify>
  <done>Tests pass, cover validation error cases for all schema constraints</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx tsc --noEmit` succeeds
- [ ] `npm run test:run -- src/app/api/admin/cinemas` passes
- [ ] `npm run lint` passes
- [ ] Invalid request bodies return 400 with structured error
- [ ] Phase 1 complete (both admin routes validated)
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- PUT endpoint rejects malformed requests with 400
- Tests verify all validation constraints
- Phase 1: API Validation complete
</success_criteria>

<output>
After completion, create `.planning/phases/01-api-validation/01-02-SUMMARY.md`

Then update:
- `.planning/ROADMAP.md` - Mark Phase 1 complete
- `.planning/STATE.md` - Update position to Phase 2
</output>
