---
phase: 02-rate-limiting
plan: 01
type: execute
---

<objective>
Apply rate limiting to public API endpoints to prevent abuse.

Purpose: Public endpoints without rate limiting can be abused for DoS or scraping attacks.
Output: Rate-limited public API routes with tests.
</objective>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-api-validation/01-01-SUMMARY.md

**Existing rate limit utility:**
@src/lib/rate-limit.ts

**Pattern to follow:**
@src/app/api/films/search/route.ts (already has rate limiting implemented)

**Target files:**
- src/app/api/screenings/route.ts (main screenings API - RATE_LIMITS.public)
- src/app/api/search/route.ts (search API - RATE_LIMITS.search)

Note: /api/films/search already has rate limiting - no work needed.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add rate limiting to /api/screenings</name>
  <files>src/app/api/screenings/route.ts</files>
  <action>
Add rate limiting at start of GET handler:
1. Import `checkRateLimit, getClientIP, RATE_LIMITS` from "@/lib/rate-limit"
2. At start of handler (after try, before validation):
   - Get IP: `const ip = getClientIP(request);`
   - Check: `const rateLimitResult = checkRateLimit(ip, { ...RATE_LIMITS.public, prefix: "screenings" });`
   - If failed: return 429 with Retry-After header
3. Use RATE_LIMITS.public (100 req/min) since this is main data endpoint
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>Rate limiting added to screenings route</done>
</task>

<task type="auto">
  <name>Task 2: Add rate limiting to /api/search</name>
  <files>src/app/api/search/route.ts</files>
  <action>
Add rate limiting at start of GET handler:
1. Import `checkRateLimit, getClientIP, RATE_LIMITS` from "@/lib/rate-limit"
2. At start of handler:
   - Get IP: `const ip = getClientIP(request);`
   - Check: `const rateLimitResult = checkRateLimit(ip, { ...RATE_LIMITS.search, prefix: "search" });`
   - If failed: return 429 with Retry-After header
3. Use RATE_LIMITS.search (30 req/min) since search is more expensive
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>Rate limiting added to search route</done>
</task>

<task type="auto">
  <name>Task 3: Add tests for rate limiting</name>
  <files>src/app/api/screenings/route.test.ts, src/app/api/search/route.test.ts</files>
  <action>
Create/update test files with rate limit tests:
1. Mock @/lib/rate-limit module
2. Test cases:
   - Returns 200 when rate limit passes
   - Returns 429 when rate limit fails
   - 429 response includes Retry-After header
  </action>
  <verify>`npm run test:run -- src/app/api/screenings src/app/api/search` passes</verify>
  <done>Tests verify rate limiting behavior</done>
</task>

</tasks>

<verification>
- [ ] `npx tsc --noEmit` succeeds
- [ ] `npm run test:run` passes for affected routes
- [ ] Rate limited routes return 429 with Retry-After when limit exceeded
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Public endpoints protected with rate limiting
</success_criteria>

<output>
After completion, create `.planning/phases/02-rate-limiting/02-01-SUMMARY.md`
Then update STATE.md and ROADMAP.md
</output>
